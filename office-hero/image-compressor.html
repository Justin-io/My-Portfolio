<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bulk Compressor | Office Hero</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>

<body>
    <div class="container">
        <div class="back-nav">
            <a href="../index.html#utilities" class="back-btn">
                <i class="fas fa-arrow-left"></i> Back to Tools
            </a>
        </div>

        <header>
            <div class="icon-box" style="margin: 0 auto 1.5rem auto;">
                <i class="fas fa-compress-arrows-alt"></i>
            </div>
            <h1 class="brand">Bulk Image Compressor</h1>
            <p class="tagline">Compress multiple images at once without losing quality. Fast and local.</p>
        </header>

        <div class="tool-interface">
            <div class="drop-zone" id="drop-zone">
                <i class="fas fa-layer-group"
                    style="font-size: 3rem; color: var(--text-secondary); margin-bottom: 1rem;"></i>
                <p id="file-label">Upload Images (JPG, PNG)</p>
                <input type="file" id="file-input" accept="image/*" multiple style="display: none;">
            </div>

            <div id="file-list-container" style="text-align: left; margin-bottom: 2rem;">
                <!-- Files will appear here -->
            </div>

            <div id="controls" style="display: none; margin-bottom: 2rem;">
                <div style="margin-bottom: 1.5rem;">
                    <label style="color: var(--text-secondary); margin-right: 1rem;">Compression Level:</label>
                    <input type="range" id="quality" min="0.1" max="0.9" step="0.1" value="0.6">
                    <span id="quality-val" style="color: var(--accent); font-weight: bold;">60%</span>
                </div>
                <button id="compress-btn" class="btn-action">Compress All</button>
            </div>

            <div class="result-area" id="result-area">
                <div id="progress-bar" class="progress-container" style="display: block;">
                    <div id="progress-fill" class="progress-fill"></div>
                </div>
                <p id="status-text" class="status-text"></p>
                <div id="download-section" style="display: none; margin-top: 1.5rem;">
                    <h3 style="color: var(--success); margin-bottom: 1rem;">Compression Complete!</h3>
                    <p id="savings-text" style="color: var(--text-secondary); margin-bottom: 1rem;"></p>
                    <button class="btn-action" id="download-zip-btn">Download ZIP</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const fileListContainer = document.getElementById('file-list-container');
        const controls = document.getElementById('controls');
        const compressBtn = document.getElementById('compress-btn');
        const qualitySlider = document.getElementById('quality');
        const qualityVal = document.getElementById('quality-val');
        const resultArea = document.getElementById('result-area');
        const progressFill = document.getElementById('progress-fill');
        const statusText = document.getElementById('status-text');
        const downloadSection = document.getElementById('download-section');
        const downloadZipBtn = document.getElementById('download-zip-btn');
        const savingsText = document.getElementById('savings-text');

        let selectedFiles = [];
        let compressedBlobMap = []; // Stores {name, blob}

        qualitySlider.addEventListener('input', (e) => {
            qualityVal.innerText = Math.round(e.target.value * 100) + '%';
        });

        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

        function handleFiles(files) {
            selectedFiles = Array.from(files).filter(f => f.type.startsWith('image/'));
            if (selectedFiles.length === 0) return;

            updateFileList();
            controls.style.display = 'block';
        }

        function updateFileList() {
            fileListContainer.innerHTML = selectedFiles.map(f => `
                <div class="file-item" style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                    <span><i class="fas fa-file-image" style="color: var(--accent); margin-right: 10px;"></i> ${f.name}</span>
                    <span style="color: var(--text-secondary); font-size: 0.9rem;">${(f.size / 1024 / 1024).toFixed(2)} MB</span>
                </div>
            `).join('');
        }

        compressBtn.addEventListener('click', async () => {
            compressBtn.disabled = true;
            resultArea.style.display = 'block';
            resultArea.classList.add('active');
            downloadSection.style.display = 'none';
            statusText.innerText = "Initializing...";
            progressFill.style.width = '0%';

            compressedBlobMap = [];
            let totalOriginalSize = 0;
            let totalCompressedSize = 0;

            const quality = parseFloat(qualitySlider.value);
            let processed = 0;

            for (const file of selectedFiles) {
                try {
                    statusText.innerText = `Compressing ${file.name}...`;
                    totalOriginalSize += file.size;

                    const blob = await compressImage(file, quality);
                    totalCompressedSize += blob.size;

                    compressedBlobMap.push({ name: file.name, blob: blob });
                } catch (err) {
                    console.error(err);
                }

                processed++;
                progressFill.style.width = (processed / selectedFiles.length * 100) + '%';
            }

            statusText.innerText = "Finalizing ZIP...";

            // Calculate savings
            const savings = ((totalOriginalSize - totalCompressedSize) / totalOriginalSize * 100).toFixed(1);
            savingsText.innerText = `Saved ${savings}% space! (${(totalOriginalSize / 1024 / 1024).toFixed(2)}MB â†’ ${(totalCompressedSize / 1024 / 1024).toFixed(2)}MB)`;

            downloadSection.style.display = 'block';
            compressBtn.disabled = false;
        });

        downloadZipBtn.addEventListener('click', () => {
            const zip = new JSZip();
            compressedBlobMap.forEach(item => {
                zip.file("min_" + item.name, item.blob);
            });

            zip.generateAsync({ type: "blob" })
                .then(function (content) {
                    saveAs(content, "office-hero-compressed.zip");
                });
        });

        function compressImage(file, quality) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.src = URL.createObjectURL(file);
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);

                    canvas.toBlob((blob) => {
                        resolve(blob);
                    }, 'image/jpeg', quality);
                };
                img.onerror = reject;
            });
        }
    </script>
</body>

</html>